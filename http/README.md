# 加解密https

## 密码学简介  

数据加密又称密码学，它是一门历史悠久的技术，指通过加密算法和
加密密钥将明文文件转变为密文文件，而解密则是通过解密算法和解
密密钥将密文文件恢复为明文文件。数据加密目前仍是计算机系统对
信息进行保护的一种最可靠的办法。它利用密码技术对文件加密，实
现信息隐蔽，从而起到保护文件的安全的作用。

1. 按密码特征分类  

- 对称密码  
发送方和接收方使用相同的单个密钥 ,这种密钥既用于加密，也用于解密。  
- 非对称密码  
发送方和接收方使用一对不同密钥：一个用于加密信息，另一个则用于解密信息。两个密钥之间存在着相互依存关系：即用
其中任一个密钥加密的信息只能用另一个密钥进行解密。  

2. 按照加密方式分类  

- 分组密码  
分组密码是将明文分成固定长度的组，用同一密钥和算法对每一块加密，对每个输入块产生一个输出块，输出也是固定长度的密文。典
型的分组密码算法有DES、AES等。  
- 流密码  
也称序列密码， 是将明文消息按字符逐位地加密，连续地处理输入明文，并随着该加密的进行，一次产生一个密文的输出，即一次加密
一个比特或一个字节。RC4就是属于流密码算法。  


## 加密算法种类和特性  

1. 种类  
- 对称加密算法
- 非对称加密算法
- hash算法
2. 特性  
- 保密性： 防止用户标识或数据被读取 
- 数据完整性： 防止数据被篡改
- 身份验证（抗抵赖性）： 确保数据发自特定的一方

## 对称加密算法

对称加密算法指加密和解密使用相同密钥的加密算法  
*优点：*
- 用户只用记住一个密钥，就可用于加密、解密
- 使用长密钥时 难以破解
- 加解密计算量小，速度快，简单易用，适合对海量数据加密  

*缺点：*
- 如果密钥交换不安全，密钥的安全性就会丧失
- 如果用户比较多 密钥管理比较麻烦
- 如果一个密钥对个用户使用，不能提供抗抵赖性

*常见的对称加密算法*
- DES算法  
DES算法，即美国数据加密标准算法,是1972年美国IBM公司研制的对称密码体制加密算法。明文按64位进行分组,密
钥长度为64位,密钥事实上是56位参与DES运算。  
- 3DES算法  
3DES又称Triple DES，是DES加密算法的一种模式，它使用2条不同的56位的密钥对数据进行三次加密。3DES是DES
向AES过渡的加密算法（1999年，NIST将3-DES指定为过渡的加密标准）。  
- AES算法  
密码学中的高级加密标准(AdvancedEncryptionStandard,AES),是美国联邦政府采用的一种区块加密标准。这个标准用
来替代原先的DES,已经被多方分析且广为全世界所使用。  
- SM4算法  
SM4算法全称为SM4分组密码算法,是国家密码管理局2012年3月发布的第23号公告中公布的密码行业标准。SM4算
法是一个分组对称密钥算法,明文、密钥、密文都是16字节。  

## 非对称加密算法  

加密和解密使用不同的秘钥，一把作为公开的公钥，另一把作为私钥。公钥加密的信息，
只有私钥才能解密。私钥加密的信息，只有公钥才能解密。 私钥只能由一方安全保管，不
能外泄，而公钥则可以发给任何请求它的人。非对称加密使用这对密钥中的一个进行加密，
而解密则需要另一个密钥。  

*优点：*
- 安全性更高，公钥是公开的，秘钥是自己保存的，不需要将私钥给别人
- 相对于对称加密，加密密钥的分发变的十分简单
- 由于每个用户的私钥是唯一的，其他用户除了可以通过信息发送者的公钥来验证信息的来源是否真实。  
*缺点：*
- 加密和解密花费时间长、速度慢，只适合对少量数据进行加密。 

*常见的非对称加密算法*  
- RSA算法  
RSA是被研究最广泛的公钥算法,从1978年提出到现在已近四十年,期间它经历了各种攻击的考验,逐渐被人们接受,
是目前应用最广泛的公钥方案之一。  
- ECC算法  
椭圆加密算法（ECC）是一种公钥加密体制，最初由Koblitz和Miller两人于1985年提出，其数学基础是利用椭圆
曲线上的有理点构成Abel加法群上椭圆离散对数的计算困难性。  
- SM2算法  
SM2算法全称为SM2椭圆曲线公钥密码算法,是国家密码管理局2010年12月发布的第21号公告中公布的密码行业标准。
SM2算法相比较其他非对称公钥算法如RSA而言使用更短的密钥串就能实现比较牢固的加密强度,同时由于其良好的
数学设计结构,加密速度也比RSA算法快。在我们国家商用密码体系中被用来替换RSA算法。  


## hash算法 (散列算法)  

Hash是一种单向算法，不可逆性，用户可以通过Hash算法
对目标信息生成一段特定长度的唯一的Hash值
（散列值，也被称为哈希摘要），却不能通过
这个Hash值重新获得目标信息。因此Hash算法
常用在不可还原的密码存储、信息完整性校验。  

*特点*    
- hash值是不可预测的  
- hash函数是单向函数，不可逆  
- hash函数具有确定性（唯一性）,对于输入X应该总是产生相同的输出Y  
*碰撞*   
- 两个不同的原始值在经过哈希运算后得到同样的结果，这样就是哈希碰撞。作为一
种可用的散列算法，其位数一定是有限的，也就是说它能记录的文件是有限的——而文件
数量是无限的，两个文件指纹发生碰撞的概率永远不会是零。  

*常见的hash算法*  
- md5  
MD5信息摘要算法,一种被广泛使用的密码散列函数，可以产生出一个128位（16字节）的散列值（hash value），用于确保信息传输完整一致。MD5由美国密码学家罗纳德·李维斯特（Ronald Linn Rivest）设计，于1992年公开，用以取代MD4算法。这套算法的程序在 RFC 1321 标准中被加以规范。1996年后该算法被证实存在弱点，可以被加以破解，对于需要高度安全性的数据，专家一般建议改用其他算法，如SHA-2。2004年，证实MD5算法无法防止碰撞（collision），因此不适用于安全性认证，如SSL公开密钥认证或是数字签名等用途。  
- SHA系列算法  
SHA系列算法由美国国家安全局（NSA）所设计，并由美国国家标准与技术研究院（NIST）发布，是美国的政府标
准。SHA系列算法主要包含两个版本，分别为SHA-1和SHA-2。它们两者之间在构造上和签名的位数上都有不同。
SHA-1在许多安全协定中广为使用，被视为是MD5的后继者，从2011年到2015年， SHA-1是现在用途最广泛的一种
算法。包括GitHub在内的众多版本控制工具以及各种云同步服务都是用SHA1来区别文件，很多安全证书或是签名
也使用SHA1来保证唯一性。
而SHA-2又可以看做是SHA-1的继承者，因为这是一个整体上的改进。SHA-2中包含多种算法，如：SHA-224、SHA-
256、SHA-384和SHA-512。其长度各不相同，其中最受欢迎的是256位的。
现在对于一些大的商业机构来说，MD5和SHA1已经不够安全，推荐至少使用SHA2-256算法。  


## 数字证书  

数字证书是由证书认证机构（CA）对证书申请者真实身份验证之后，用CA的根证书对申请人的一些基本信息以及申请人的公钥进行签名（相当于加盖发证书机构的公章）后形成的一个数字文件。 X509是数字证书的基本规范。

*不同证书后缀含义：*    
- .der：用二进制DER编码的证书
- .pem：用ASCLL(BASE64)编码的证书
- .cer/.crt：只包含公钥。可能是DER编码，也可能是ASCLL(BASE64)编码。
- .pfx/.p12用于存放个人证书/私钥，通常包含保护密码，二进制方式

*数字证书的作用：*  
- 身份授权。确保浏览器访问的网站是经过CA验证的可信任的网站。  
- 分发公钥。每个数字证书都包含了注册者生成的公钥（验证确保是合法的，非伪造的公钥）。  
- 验证证书合法性。客户端接收到数字证书后，会对证书合法性进行验证。只有验证通过后的证书，才能够进行后续通信过程。 

*X509标准 数字证书包含的主要内容：*  
- 版本信息【V3】  
- 序列号
- 颁发者  
- 使用者 【域名】
- 有效期始【2018年9月18日 8:00:00 】  
- 有效期止【2019年9月18日 20:00:00】
- 签名算法【sha256RSA】  
- 签名哈希算法【sha256】  
- 公钥 
- 指纹在·  


## https 原理简述  

HTTPS是以安全为目标的HTTP通道，简单讲是HTTP的安全版，
即HTTP下加入SSL层，HTTPS的安全基础是SSL
(Secure Sockets Layer 安全套接层)，因此加密的详细内
容就需要SSL。  

*HTTPS和HTTP的主要区别：*  
- HTTPS协议需要到ca申请证书，一般免费证书较少，需要
支付一定费用。  
- HTTP是超文本传输协议，信息是明文传输，https则是具
有安全性的SSL加密传输协议。  
- HTTP和HTTPS使用的是完全不同的连接方式，用的端口也
不一样，前者是80，后者是443。  
- HTTP的连接很简单，是无状态的；HTTPS协议是由HTTP+SSL
协议构建的可进行加密传输、身份认证的网络协议，比HTTP
协议安全。  

*SSL协议与TLS协议*  
- SSL（Secure Socket Layer，安全套接字层）：1994年为 Netscape 所研发，SSL协议位于
TCP/IP 协议与各种应用层协议之间，为数据通讯提供安全支持。
- TLS（Transport Layer Security，传输层安全）：其前身是 SSL，它最初的几个版本（SSL 
1.0、SSL 2.0、SSL 3.0）由网景公司开发，1999年从 3.1 开始被 IETF 标准化并改名，发展
至今已经有 TLS 1.0、TLS 1.1、TLS 1.2 三个版本。SSL3.0和TLS1.0由于存在安全漏洞，已
经很少被使用到。TLS 1.3 改动会比较大，目前还在草案阶段，目前使用最广泛的是TLS 1.1、TLS 1.2。    

SSL是专门用户保护Web通讯的，目前版本为3.0。最新版本的TLS 1.0是
IETF （The Internet Engineering Task Force - 互联网工程任务组）
制定的一种新的协议，它建立在SSL 3.0协议规范之上，是SSL 3.0的后
续版本。两者差别极小，可以理解为SSL 3.1，它是写入了RFC的。 


## https传输

1. 客户端向一个需要https访问的网站发起请求。  

2.  服务器将证书发送给客户端进行校验。证书里面包含了其公钥。这里要特别说一下客户端到底如何来校验对方发过来的数字证书是否有效。 
  - 首先浏览器读取证书中的证书所有者、有效期等信息进行一一校验。 
  - 浏览器开始查找操作系统中已内置的受信任的证书发布机构CA，与服务器发来的证书中的颁发者CA比对，用于校验证书是否为合法机构颁发。如果找不到，浏览器就会报错，说明服务器发来的证书是不可信任的。
  - 找到对应的颁发者CA后，浏览器就会从操作系统中取出 颁发者CA（也就是根证书） 的公钥，然后对服务器证书的指纹用根公钥解密得到证书加密的hash1，
  - 再用ca证书上的指纹算法进行hash算法，得到hash2。 
  -  比较hash1和hash2一样，如果一样则通过认证。
  - 补充说明，ca证书左右就是分发服务器的公钥，CA机构判断这个证书的真伪。CA证书就相当于服务器的身份证，ca机构加了防止伪造标识，CA机构的公钥一般是内置在操作系统中。证书中的指纹  是怎么生成的 是， CA机构的RSA私钥加密证书，得找证书的密文，在把密文用证书上指纹算法进行数字签名。  
  - 证书申请，需要认证的服务器，会想CA申请证书，把公钥给CA，CA对数字证书进行防篡改认证等等等身份认证。客户端发起https请求，服务器就会将数字证书发送到客户端。

3. 校验成功之后，客户端会生成一个对称加密信息（包含对称加密算法和对称加密密钥）然后使用服务器证书的公钥进行加密之后发送给服务器。  
4. 服务器通过使用自己的私钥解密得到这个信息，并用该密钥加密回复客户端。  
5. 客户端的请求信息统一使用约定的密钥对通讯内容进行加解密。  
6. 服务器的响应信息也会使用约定的密钥对通讯内容进行加解密。




## 实例说明  

*发送方*  
1. 使用 随机密钥 对 原数据 进行加密（AES算法），得到 加密数据  
2. 使用 对方公钥 对 随机密钥 进行加密（RSA算法），得到 随机密钥密文 
3. 使用 己方私钥 对 加密数据 进行签名（先使用SHA-256算法进行摘要，再用RSA对摘要进行加密），得到 签名数据  

*接收方*  
1. 使用 对方公钥 对 加密数据 进行签名，得到 签名数据，并对比接收的签名数据，判断是否一致
2. 使用 己方私钥 对 随机密钥密文 进行解密（RSA算法），得到 随机密钥
3. 使用 随机密钥 对 加密数据 进行解密（AES算法），得到 原数据


## 总结  

在实际的操作过程中，我们通常会综合各种加密算法来对数据进行加密处理：比如可
以采用非对称加密算法管理对称算法的密钥，使用对称加密算法加密数据，使用这样
我们就可以集成两类加密算法的优点，既实现了加密速度快的优点，又实现了安全方
便管理密钥的优点。另外也可以使用Hash算法对数据进行摘要，保证内容的完整性防
止被恶意篡改。